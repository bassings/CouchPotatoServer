<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>{% block title %}CouchPotato{% endblock %}</title>

<!-- PWA Meta Tags -->
<meta name="description" content="Download movies automatically, easily and in the best quality as soon as they are available.">
<meta name="theme-color" content="#35c5f4">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CouchPotato">
<link rel="manifest" href="/static/manifest.json">
<link rel="apple-touch-icon" href="/static/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-96.png">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/htmx.org@2.0.4"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  darkMode: 'class',
  theme: {
    extend: {
      fontFamily: { sans: ['Inter', 'sans-serif'] },
      colors: {
        cp: {
          bg: 'var(--cp-bg)',
          card: 'var(--cp-card)',
          surface: 'var(--cp-surface)',
          border: 'var(--cp-border)',
          accent: '#35c5f4',
          accentHover: '#4dd4ff',
          text: 'var(--cp-text)',
          muted: 'var(--cp-muted)',
          success: '#3ddc84',
          warning: '#e5a00d',
          danger: '#f04848',
          blue: '#35c5f4',
        }
      }
    }
  }
}
</script>
<style>
  /* IMP-006: Theme variables */
  :root {
    --cp-bg: #0d0d0d;
    --cp-card: #161618;
    --cp-surface: #111113;
    --cp-border: #1e1e22;
    --cp-text: #e0e0e4;
    --cp-muted: #9b9ba8;
  }
  :root.light {
    --cp-bg: #f5f5f7;
    --cp-card: #ffffff;
    --cp-surface: #fafafa;
    --cp-border: #e0e0e4;
    --cp-text: #1a1a1a;
    --cp-muted: #666666;
  }
  :root.light ::-webkit-scrollbar-track { background: #f0f0f0; }
  :root.light ::-webkit-scrollbar-thumb { background: #c0c0c0; }
  :root.light ::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
  :root.light .poster-card:hover { border-color: rgba(53,197,244,0.3); box-shadow: 0 0 20px rgba(53,197,244,0.1); }
  :root.light .bg-black\/80 { background-color: rgba(255,255,255,0.9); }
  :root.light .bg-black\/60 { background-color: rgba(255,255,255,0.8); }
  :root.light .border-white\/\[0\.04\], :root.light .border-white\/\[0\.05\], :root.light .border-white\/\[0\.06\] { border-color: rgba(0,0,0,0.08); }
  :root.light .bg-white\/\[0\.03\] { background-color: rgba(0,0,0,0.04); }
  :root.light .text-white\/80, :root.light .text-white\/90, :root.light .text-white { color: var(--cp-text); }
  /* A11Y: Use darker accent text in light mode for sufficient contrast on bg-cp-accent/10 */
  :root.light .text-cp-accent { color: #0e7490; }

  [x-cloak] { display: none !important; }
  * { letter-spacing: -0.01em; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: #0d0d0d; }
  ::-webkit-scrollbar-thumb { background: #1e1e22; border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: #2a2a30; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .poster-card { transition: border-color 0.2s ease, box-shadow 0.2s ease; }
  .poster-card:hover { border-color: rgba(53,197,244,0.15); box-shadow: 0 0 20px rgba(53,197,244,0.06); }
  .fade-in { animation: fadeIn 0.2s ease-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  .htmx-indicator { display: none !important; }
  .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { display: flex !important; }
  
  /* A11Y: Focus indicators (A11Y-013) */
  :focus-visible { outline: 2px solid #35c5f4; outline-offset: 2px; }
  :focus:not(:focus-visible) { outline: none; }
  
  /* A11Y: Skip link styles (A11Y-003) */
  .skip-link { position: absolute; left: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; z-index: 9999; }
  .skip-link:focus { position: fixed; top: 1rem; left: 1rem; width: auto; height: auto; padding: 0.75rem 1.5rem; background: #35c5f4; color: #0d0d0d; font-weight: 600; border-radius: 0.5rem; text-decoration: none; }
  
  /* A11Y: Screen reader only utility */
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  
  /* A11Y: Reduced motion support (A11Y-006) */
  @media (prefers-reduced-motion: reduce) {
    .fade-in { animation: none; }
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }
</style>
<script>
  const CP = {
    apiBase: '{{ api_base }}',
    newBase: '{{ new_base }}',
    webBase: '{{ web_base }}'
  };
  
  function appShell() {
    return {
      sidebarCollapsed: false,
      mobileMenu: false,
      updateAvailable: null,
      version: '',
      darkMode: true,

      init() {
        // IMP-006: Load theme preference
        const saved = localStorage.getItem('cp-theme');
        if (saved === 'light') {
          this.darkMode = false;
          document.documentElement.classList.add('light');
        } else if (saved === 'dark') {
          this.darkMode = true;
          document.documentElement.classList.remove('light');
        } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
          this.darkMode = false;
          document.documentElement.classList.add('light');
        }
      },

      toggleTheme() {
        this.darkMode = !this.darkMode;
        if (this.darkMode) {
          document.documentElement.classList.remove('light');
          localStorage.setItem('cp-theme', 'dark');
        } else {
          document.documentElement.classList.add('light');
          localStorage.setItem('cp-theme', 'light');
        }
      },

      async checkForUpdates() {
        try {
          const resp = await fetch(CP.apiBase + '/updater.info/');
          const data = await resp.json();
          if (data.version) {
            this.version = data.version.repr || data.version.hash?.substring(0,7) || '';
          }
          if (data.update_version) {
            this.updateAvailable = data.update_version;
          }
        } catch (e) { /* update check is optional */ }
      }
    };
  }
</script>
</head>
<body class="bg-cp-bg text-cp-text font-sans min-h-screen antialiased" x-data="appShell()" x-init="init(); checkForUpdates()" x-cloak>

<!-- A11Y: Skip link (A11Y-003) -->
<a href="#main-content" class="skip-link">Skip to main content</a>

<!-- SIDEBAR (desktop) -->
<aside class="fixed left-0 top-0 bottom-0 z-40 hidden lg:flex flex-col bg-black/80 backdrop-blur-xl border-r border-white/[0.04] transition-all duration-300"
       :class="sidebarCollapsed ? 'w-16' : 'w-56'">
  <div class="flex items-center gap-3 px-4 h-14 border-b border-white/[0.04] shrink-0">
    <a href="{{ new_base }}" class="flex items-center gap-3">
      <div class="w-7 h-7 rounded bg-cp-accent/10 flex items-center justify-center font-semibold text-cp-accent text-xs shrink-0 tracking-tight">CP</div>
      <span class="font-semibold text-sm whitespace-nowrap overflow-hidden transition-all tracking-tight" :class="sidebarCollapsed ? 'w-0 opacity-0' : 'w-auto opacity-100'">CouchPotato</span>
    </a>
  </div>
  <nav class="flex-1 py-3 space-y-0.5 px-2" aria-label="Main navigation">
    {% set nav_items = [
      ('wanted', 'Wanted', 'M9.348 14.652a3.75 3.75 0 010-5.304m5.304 0a3.75 3.75 0 010 5.304m-7.425 2.121a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.788m13.788 0c3.808 3.808 3.808 9.98 0 13.788M12 12h.008v.008H12V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z'),
      ('available', 'Available', 'M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z'),
      ('suggestions', 'Suggestions', 'M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z'),
      ('add', 'Add Movie', 'M12 4.5v15m7.5-7.5h-15'),
      ('settings', 'Settings', 'M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z M15 12a3 3 0 11-6 0 3 3 0 016 0z'),
    ] %}
    {% for id, label, icon in nav_items %}
    <a href="{{ new_base }}{{ id }}/" class="w-full flex items-center gap-3 px-3 py-2 rounded transition-colors {% if current_page is defined and current_page == id %}bg-cp-accent/10 text-cp-accent{% else %}text-cp-muted hover:text-cp-text hover:bg-white/[0.03]{% endif %}" {% if current_page is defined and current_page == id %}aria-current="page"{% endif %}>
      <svg aria-hidden="true" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="{{ icon }}"></path>
      </svg>
      <span class="whitespace-nowrap overflow-hidden transition-all text-[13px] font-medium" :class="sidebarCollapsed ? 'w-0 opacity-0' : 'w-auto opacity-100'">{{ label }}</span>
    </a>
    {% endfor %}
    <div class="pt-2 mt-2 border-t border-white/[0.04]">
      <a href="{{ web_base }}old/" class="w-full flex items-center gap-3 px-3 py-2 rounded transition-colors text-cp-muted hover:text-cp-text hover:bg-white/[0.03]">
        <svg aria-hidden="true" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"></path>
        </svg>
        <span class="whitespace-nowrap overflow-hidden transition-all text-[13px] font-medium" :class="sidebarCollapsed ? 'w-0 opacity-0' : 'w-auto opacity-100'">Classic UI</span>
      </a>
    </div>
  </nav>
  <!-- Update available indicator -->
  <a x-show="updateAvailable" :href="updateAvailable?.changelog || '#'" target="_blank"
     class="mx-2 mb-2 px-3 py-2 rounded-lg bg-cp-success/10 border border-cp-success/20 flex items-center gap-2 text-cp-success hover:bg-cp-success/15 transition-colors"
     :class="sidebarCollapsed ? 'justify-center' : ''">
    <svg aria-hidden="true" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
    <span class="text-xs font-medium whitespace-nowrap overflow-hidden transition-all" :class="sidebarCollapsed ? 'w-0 opacity-0' : 'w-auto opacity-100'" x-text="updateAvailable?.hash + ' available'"></span>
    <span class="sr-only">Update available (opens in new tab)</span>
  </a>
  <!-- Version display -->
  <div x-show="version && !updateAvailable" class="mx-2 mb-2 px-3 py-1.5 text-center"
       :class="sidebarCollapsed ? '' : ''">
    <span class="text-[10px] text-cp-muted" x-text="'v' + version"></span>
  </div>
  <!-- IMP-006: Theme toggle -->
  <button @click="toggleTheme()"
          class="w-full flex items-center gap-3 px-4 py-2 text-cp-muted hover:text-cp-text transition-colors border-t border-cp-border"
          :aria-label="darkMode ? 'Switch to light mode' : 'Switch to dark mode'">
    <svg x-show="darkMode" aria-hidden="true" class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
    </svg>
    <svg x-show="!darkMode" aria-hidden="true" class="w-4 h-4 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/>
    </svg>
    <span class="text-[13px] whitespace-nowrap overflow-hidden transition-all" :class="sidebarCollapsed ? 'w-0 opacity-0' : 'w-auto opacity-100'" x-text="darkMode ? 'Light mode' : 'Dark mode'"></span>
  </button>
  <button @click="sidebarCollapsed = !sidebarCollapsed" 
          class="p-4 border-t border-cp-border text-cp-muted hover:text-cp-text transition-colors" 
          :aria-expanded="(!sidebarCollapsed).toString()"
          :aria-label="sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'">
    <svg aria-hidden="true" class="w-4 h-4 transition-transform" :class="sidebarCollapsed ? 'rotate-180' : ''" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"></path>
    </svg>
  </button>
</aside>

<!-- MOBILE TOP BAR -->
<header class="lg:hidden fixed top-0 left-0 right-0 z-40 h-12 bg-black/80 backdrop-blur-xl border-b border-white/[0.04] flex items-center justify-between px-4">
  <div class="flex items-center gap-3">
    <a href="{{ new_base }}" class="flex items-center gap-3">
      <div class="w-6 h-6 rounded bg-cp-accent/10 flex items-center justify-center font-semibold text-cp-accent text-[10px] tracking-tight">CP</div>
      <span class="font-semibold text-sm tracking-tight">CouchPotato</span>
    </a>
  </div>
  <button @click="mobileMenu = !mobileMenu" 
          class="text-cp-muted hover:text-cp-text" 
          :aria-expanded="mobileMenu.toString()"
          aria-controls="mobile-menu"
          aria-label="Toggle navigation menu">
    <svg aria-hidden="true" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"></path>
    </svg>
  </button>
</header>

<!-- MOBILE MENU OVERLAY -->
<div x-show="mobileMenu" x-transition.opacity @click="mobileMenu = false" class="lg:hidden fixed inset-0 z-40 bg-black/60" aria-hidden="true"></div>
<div x-show="mobileMenu" x-transition id="mobile-menu" role="menu" class="lg:hidden fixed top-12 right-0 z-50 w-56 bg-cp-card border-l border-b border-white/[0.06] rounded-bl-md p-3 space-y-1">
  {% for id, label, icon in nav_items %}
  <a href="{{ new_base }}{{ id }}/" @click="mobileMenu = false" role="menuitem" class="flex items-center gap-3 px-3 py-2 rounded transition-colors {% if current_page is defined and current_page == id %}bg-cp-accent/10 text-cp-accent{% else %}text-cp-muted hover:text-cp-text hover:bg-white/[0.03]{% endif %}">
    <svg aria-hidden="true" class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="{{ icon }}"></path></svg>
    <span class="text-[13px] font-medium">{{ label }}</span>
  </a>
  {% endfor %}
</div>

<!-- MOBILE BOTTOM NAV -->
<nav class="lg:hidden fixed bottom-0 left-0 right-0 z-40 bg-black/80 backdrop-blur-xl border-t border-white/[0.04]" aria-label="Mobile navigation">
  <div class="flex justify-around" role="menubar">
    {% for id, label, icon in nav_items %}
    <a href="{{ new_base }}{{ id }}/" role="menuitem" class="flex flex-col items-center py-2 px-3 min-w-0 flex-1 transition-colors {% if current_page is defined and current_page == id %}text-cp-accent{% else %}text-cp-muted{% endif %}" {% if current_page is defined and current_page == id %}aria-current="page"{% endif %}>
      <svg aria-hidden="true" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="{{ icon }}"></path></svg>
      <span class="text-[10px] mt-0.5 truncate">{{ label }}</span>
    </a>
    {% endfor %}
  </div>
</nav>

<!-- MAIN CONTENT -->
<main id="main-content" class="lg:transition-all lg:duration-300 pb-16 lg:pb-0 pt-12 lg:pt-0" :class="sidebarCollapsed ? 'lg:ml-16' : 'lg:ml-56'" tabindex="-1">
  {% block content %}{% endblock %}
</main>

<!-- Movie Info Modal (used by suggestions, charts, and search) -->
{% include "partials/movie_info_modal.html" %}

<!-- PWA Service Worker Registration -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/static/sw.js')
      .then(reg => {
        console.log('[PWA] Service Worker registered:', reg.scope);
        // Check for updates periodically
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New content available, show refresh prompt
              if (confirm('New version available! Reload to update?')) {
                newWorker.postMessage('skipWaiting');
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(err => console.log('[PWA] Service Worker registration failed:', err));
  });
}
</script>

</body>
</html>
