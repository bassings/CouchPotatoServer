{% extends "base.html" %}
{% block title %}{{ 'Wanted' if current_page == 'wanted' else 'Available' }} â€” CouchPotato{% endblock %}
{% block content %}
<div class="p-4 lg:p-8 fade-in" x-data="movieList()">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
    <div>
      <h1 class="text-xl font-semibold tracking-tight">{{ 'Wanted' if current_page == 'wanted' else 'Available' }}</h1>
      <p class="text-cp-muted text-xs mt-1 font-light" id="movie-count"></p>
    </div>
    <div class="flex items-center gap-3">
      {% if current_page == 'wanted' %}
      <div class="flex gap-1 text-[10px]">
        <button @click="filterStatus = ''" :class="filterStatus === '' ? 'bg-cp-accent/10 text-cp-accent' : 'bg-white/[0.03] text-cp-muted hover:text-cp-text'" class="px-2.5 py-1 rounded-md transition-colors">All</button>
        <button @click="filterStatus = 'active'" :class="filterStatus === 'active' ? 'bg-cp-accent/10 text-cp-accent' : 'bg-white/[0.03] text-cp-muted hover:text-cp-text'" class="px-2.5 py-1 rounded-md transition-colors">Wanted</button>
        <button @click="filterStatus = 'done'" :class="filterStatus === 'done' ? 'bg-cp-success/10 text-cp-success' : 'bg-white/[0.03] text-cp-muted hover:text-cp-text'" class="px-2.5 py-1 rounded-md transition-colors">Done</button>
      </div>
      {% endif %}
      <div class="relative w-full sm:w-64">
        <input type="text" x-model="search" placeholder="Filter movies..." @input="filterMovies()"
               class="w-full bg-white/[0.03] border border-white/[0.06] rounded-md px-3 py-1.5 pl-8 text-xs focus:outline-none focus:border-cp-accent/30 placeholder-cp-muted">
        <svg class="absolute left-2.5 top-2 w-3.5 h-3.5 text-cp-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path></svg>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div id="loading" class="htmx-indicator items-center justify-center py-12">
    <svg class="animate-spin w-6 h-6 text-cp-accent" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
  </div>

  <!-- Movie grid (loaded via htmx) -->
  <div id="movie-grid"
       hx-get="{{ new_base }}partial/movies?status={{ 'active' if current_page == 'wanted' else 'done' }}"
       hx-trigger="load"
       hx-indicator="#loading"
       class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
  </div>
</div>

<script>
function movieList() {
  return {
    search: '',
    filterStatus: '',
    filterMovies() {
      const q = this.search.toLowerCase();
      document.querySelectorAll('#movie-grid .poster-card').forEach(card => {
        const title = (card.dataset.title || '').toLowerCase();
        const status = card.dataset.status || '';
        const matchSearch = !q || title.includes(q);
        const matchStatus = !this.filterStatus || status === this.filterStatus;
        card.style.display = (matchSearch && matchStatus) ? '' : 'none';
      });
      this.updateCount();
    },
    updateCount() {
      const visible = document.querySelectorAll('#movie-grid .poster-card:not([style*="display: none"])').length;
      const el = document.getElementById('movie-count');
      if (el) el.textContent = visible + ' movies';
    },
    init() {
      // Update count after htmx loads
      document.body.addEventListener('htmx:afterSwap', (e) => {
        if (e.detail.target.id === 'movie-grid') this.updateCount();
      });
    }
  };
}
</script>
{% endblock %}
