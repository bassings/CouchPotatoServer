<!-- Movie Info Modal - Reusable across suggestions, charts, and search -->
<div x-data="movieInfoModal()" x-cloak>
  <template x-teleport="body">
    <div x-show="isOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         @click.self="close()"
         @keydown.escape.window="close()"
         role="dialog"
         aria-modal="true"
         :aria-label="movie?.title || 'Movie details'"
         class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 overflow-y-auto">
      
      <div class="bg-cp-bg border border-white/[0.08] rounded-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto"
           @click.stop
           @keydown.tab="trapFocus($event)">
        
        <!-- Loading state -->
        <div x-show="loading" class="p-8 text-center">
          <svg class="animate-spin w-8 h-8 text-cp-accent mx-auto" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
          </svg>
          <p class="text-cp-muted text-sm mt-3">Loading movie details...</p>
        </div>
        
        <!-- Content -->
        <div x-show="!loading && movie" class="relative">
          <!-- Close button -->
          <button @click="close()"
                  id="movie-modal-close"
                  class="absolute top-3 right-3 z-10 p-2 rounded-md bg-black/40 text-white/80 hover:text-white hover:bg-black/60 transition-colors backdrop-blur-sm"
                  aria-label="Close movie details">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
          
          <!-- Header with poster -->
          <div class="flex flex-col sm:flex-row gap-4 p-4 sm:p-6">
            <!-- Poster -->
            <div class="shrink-0 w-32 sm:w-40 mx-auto sm:mx-0">
              <template x-if="movie?.poster">
                <img :src="movie.poster" :alt="movie.title" class="w-full aspect-[2/3] object-cover rounded-md border border-white/[0.08]">
              </template>
              <template x-if="!movie?.poster">
                <div class="w-full aspect-[2/3] rounded-md border border-white/[0.08] bg-cp-surface flex items-center justify-center">
                  <svg class="w-10 h-10 text-cp-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 21h16.5a2.25 2.25 0 0 0 2.25-2.25V5.25a2.25 2.25 0 0 0-2.25-2.25H3.75a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 3.75 21Z"/>
                  </svg>
                </div>
              </template>
            </div>
            
            <!-- Info -->
            <div class="flex-1 min-w-0 text-center sm:text-left">
              <h2 class="text-lg sm:text-xl font-semibold tracking-tight" x-text="movie?.title || 'Unknown'"></h2>
              
              <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2 mt-2 text-xs text-cp-muted">
                <span x-show="movie?.year" x-text="movie?.year"></span>
                <template x-if="movie?.rating">
                  <span class="flex items-center gap-1">
                    <span class="text-white/10">|</span>
                    <span>⭐</span>
                    <span x-text="movie?.rating"></span>
                  </span>
                </template>
                <template x-if="movie?.runtime">
                  <span>
                    <span class="text-white/10">|</span>
                    <span x-text="movie?.runtime + ' min'"></span>
                  </span>
                </template>
              </div>
              
              <!-- Genres -->
              <div x-show="movie?.genres?.length" class="flex flex-wrap gap-1.5 mt-3 justify-center sm:justify-start">
                <template x-for="genre in movie?.genres?.slice(0, 4)" :key="genre">
                  <span class="px-2 py-0.5 rounded text-[10px] font-medium bg-white/[0.06] text-cp-muted" x-text="genre"></span>
                </template>
              </div>
              
              <!-- Directors -->
              <p x-show="movie?.directors?.length" class="text-xs text-cp-muted mt-2">
                <span class="text-cp-muted/60">Dir:</span> <span x-text="movie?.directors?.slice(0, 2).join(', ')"></span>
              </p>
              
              <!-- Actors -->
              <p x-show="movie?.actors?.length" class="text-xs text-cp-muted mt-1">
                <span class="text-cp-muted/60">Cast:</span> <span x-text="movie?.actors?.slice(0, 3).join(', ')"></span>
              </p>
            </div>
          </div>
          
          <!-- Plot -->
          <div x-show="movie?.plot" class="px-4 sm:px-6 pb-4">
            <p class="text-xs text-cp-muted leading-relaxed" x-text="movie?.plot"></p>
          </div>
          
          <!-- Actions -->
          <div class="flex flex-wrap gap-2 px-4 sm:px-6 pb-4 sm:pb-6 border-t border-white/[0.05] pt-4">
            <!-- Trailer button -->
            <button @click="playTrailer()"
                    x-show="movie?.imdb"
                    class="px-3.5 py-2 bg-white/[0.04] border border-white/[0.06] hover:border-white/[0.1] text-cp-text rounded-md text-xs transition-colors flex items-center gap-1.5"
                    :disabled="trailerLoading">
              <span x-show="!trailerLoading && !showTrailer" aria-hidden="true">▶</span>
              <span x-show="!trailerLoading && !showTrailer">Trailer</span>
              <span x-show="trailerLoading">Loading...</span>
              <span x-show="showTrailer && !trailerLoading">Hide Trailer</span>
            </button>
            
            <!-- IMDb link -->
            <a x-show="movie?.imdb"
               :href="'https://www.imdb.com/title/' + movie?.imdb + '/'"
               target="_blank"
               rel="noopener"
               class="px-3.5 py-2 bg-white/[0.04] border border-white/[0.06] hover:border-white/[0.1] text-cp-text rounded-md text-xs transition-colors">
              IMDb <span class="sr-only">(opens in new tab)</span>
            </a>
            
            <!-- Quality profile selector -->
            <div x-show="movie?.imdb && !added" class="flex items-center gap-2 ml-auto">
              <label for="modal-profile-select" class="sr-only">Quality profile</label>
              <select id="modal-profile-select" x-model="selectedProfile"
                      class="bg-cp-bg border border-white/[0.06] rounded-md px-2 py-1.5 text-xs focus:outline-none focus:border-cp-accent/30"
                      hx-get="/new/partial/profiles"
                      hx-trigger="load"
                      hx-swap="innerHTML">
                <option value="">Select quality...</option>
              </select>
              
              <!-- Add button -->
              <button @click="addMovie()"
                      class="px-3.5 py-2 bg-cp-accent/10 text-cp-accent hover:bg-cp-accent/20 font-medium rounded-md text-xs transition-colors flex items-center gap-1.5"
                      :disabled="adding || !selectedProfile">
                <svg x-show="!adding" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
                </svg>
                <span x-show="!adding">Add</span>
                <span x-show="adding">Adding...</span>
              </button>
            </div>
            
            <!-- Added state -->
            <div x-show="added" class="px-3.5 py-2 bg-cp-success/10 text-cp-success rounded-md text-xs flex items-center gap-1.5 ml-auto">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
              </svg>
              <span>Added</span>
            </div>
            
            <!-- Skip button (for suggestions/charts) -->
            <button @click="skipMovie()"
                    x-show="movie?.imdb && canSkip && !skipped"
                    class="px-3.5 py-2 bg-white/[0.04] border border-white/[0.06] hover:border-white/[0.1] text-cp-muted hover:text-cp-text rounded-md text-xs transition-colors flex items-center gap-1.5">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
              <span>Skip</span>
            </button>
          </div>
          
          <!-- Trailer embed -->
          <div x-show="showTrailer && trailerVideoId" class="px-4 sm:px-6 pb-4 sm:pb-6">
            <div class="aspect-video bg-black rounded-md overflow-hidden">
              <iframe :src="showTrailer ? 'https://www.youtube.com/embed/' + trailerVideoId + '?autoplay=1' : ''"
                      class="w-full h-full"
                      frameborder="0"
                      allow="autoplay; encrypted-media"
                      allowfullscreen
                      title="Movie trailer"></iframe>
            </div>
          </div>
        </div>
        
        <!-- Error state -->
        <div x-show="!loading && error" class="p-8 text-center">
          <svg class="w-10 h-10 text-cp-danger mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z"/>
          </svg>
          <p class="text-cp-muted text-sm" x-text="error"></p>
          <button @click="close()" class="mt-4 px-4 py-2 bg-white/[0.06] hover:bg-white/[0.1] rounded-md text-xs transition-colors">Close</button>
        </div>
      </div>
    </div>
  </template>
</div>

<script>
function movieInfoModal() {
  return {
    isOpen: false,
    loading: false,
    error: null,
    movie: null,
    triggerEl: null,
    canSkip: false,
    skipType: null, // 'suggestion' or 'chart'
    added: false,
    adding: false,
    skipped: false,
    selectedProfile: '',
    trailerLoading: false,
    trailerVideoId: null,
    showTrailer: false,
    
    init() {
      // Listen for open events
      window.addEventListener('open-movie-modal', (e) => {
        this.open(e.detail.imdb, e.detail.triggerEl, e.detail.skipType);
      });
    },
    
    async open(imdb, triggerEl, skipType = null) {
      this.isOpen = true;
      this.loading = true;
      this.error = null;
      this.movie = null;
      this.triggerEl = triggerEl;
      this.canSkip = !!skipType;
      this.skipType = skipType;
      this.added = false;
      this.adding = false;
      this.skipped = false;
      this.trailerVideoId = null;
      this.showTrailer = false;
      
      try {
        const res = await fetch(CP.apiBase + '/search?q=' + imdb);
        const data = await res.json();
        
        if (data.success && data.movie && data.movie.length > 0) {
          const m = data.movie[0];
          this.movie = {
            imdb: m.imdb || imdb,
            title: (m.titles && m.titles[0]) || m.original_title || 'Unknown',
            year: m.year || null,
            plot: m.plot || '',
            poster: (m.images?.poster && m.images.poster[0]) || (m.images?.poster_original && m.images.poster_original[0]) || null,
            rating: m.rating?.imdb?.[1] || null,
            runtime: m.runtime || null,
            genres: m.genres || [],
            directors: m.directors || [],
            actors: m.actors || []
          };
        } else {
          this.error = 'Could not load movie details';
        }
      } catch (e) {
        console.error('Failed to load movie info', e);
        this.error = 'Failed to load movie details';
      }
      
      this.loading = false;
      
      // Focus close button after content loads
      this.$nextTick(() => {
        document.getElementById('movie-modal-close')?.focus();
      });
    },
    
    close() {
      this.isOpen = false;
      this.showTrailer = false;
      if (this.triggerEl) {
        this.triggerEl.focus();
      }
    },
    
    async playTrailer() {
      if (this.showTrailer) {
        this.showTrailer = false;
        return;
      }
      
      if (this.trailerVideoId) {
        this.showTrailer = true;
        return;
      }
      
      this.trailerLoading = true;
      try {
        // Use CouchPotato's trailer API which accepts IMDB IDs
        const res = await fetch(CP.apiBase + '/movie.trailer/?identifier=' + this.movie.imdb);
        const data = await res.json();
        if (data.success && data.video_id) {
          this.trailerVideoId = data.video_id;
          this.showTrailer = true;
        }
      } catch (e) {
        console.error('Failed to load trailer', e);
      }
      this.trailerLoading = false;
    },
    
    async addMovie() {
      if (!this.movie?.imdb || this.adding || !this.selectedProfile) return;
      
      this.adding = true;
      try {
        const res = await fetch(CP.apiBase + '/movie.add/?identifier=' + this.movie.imdb + '&profile_id=' + this.selectedProfile);
        const data = await res.json();
        this.added = data.success !== false;
      } catch (e) {
        console.error('Failed to add movie', e);
      }
      this.adding = false;
    },
    
    async skipMovie() {
      if (!this.movie?.imdb || !this.skipType) return;
      
      const endpoint = this.skipType === 'chart' ? '/charts.ignore/' : '/suggestion.ignore/';
      try {
        await fetch(CP.apiBase + endpoint + '?imdb=' + this.movie.imdb);
        this.skipped = true;
        // Dispatch event to remove card from grid
        window.dispatchEvent(new CustomEvent('movie-skipped', { detail: { imdb: this.movie.imdb } }));
        this.close();
      } catch (e) {
        console.error('Failed to skip movie', e);
      }
    },
    
    trapFocus(event) {
      const modal = event.currentTarget;
      const focusable = modal.querySelectorAll('button:not([disabled]), a[href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      
      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    }
  };
}
</script>
