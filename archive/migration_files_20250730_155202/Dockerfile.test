FROM python:3.12-alpine

# Install system dependencies
RUN apk add --no-cache \
    bash \
    ca-certificates \
    curl \
    git \
    gcc \
    musl-dev \
    libffi-dev \
    openssl-dev

# Create user
RUN addgroup -g 1000 -S couchpotato \
    && adduser -u 1000 -S couchpotato -G couchpotato

# Create directories
RUN mkdir -p /app /config /data /downloads /movies \
    && chown -R couchpotato:couchpotato /app /config /data /downloads /movies

# Copy application
COPY --chown=couchpotato:couchpotato . /app/

# Install Python dependencies
WORKDIR /app
RUN pip install --no-cache-dir \
    six \
    future \
    configparser \
    requests \
    chardet \
    tornado

# Install testing dependencies
RUN pip install --no-cache-dir \
    pytest \
    pytest-cov \
    flake8 \
    black \
    pylint

EXPOSE 5050

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:5050/ || exit 1

USER couchpotato
WORKDIR /app

CMD ["python3", "CouchPotato.py", "--console_log"]
